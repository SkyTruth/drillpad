{% extends "tadpole-wms/base.html" %}

{% block body %}
  <div class="row">
    <div class="span12">
      {% block steps %}
      {% endblock %}

      <div class="step mapstep">
        {% block testrun_description %}
          <h2>Test run</h2>
          <p>Pleasy try to mark any objects you see below. <span id="mapcomment"></span></p>
        {% endblock %}

        {% block row %}
          {% include "tadpole-wms/row.html" %}
        {% endblock %}

        <span id="maperrors"></span>
      </div>

      <div class="step">
        <h2>On your mark, get set, go!</h2>
        Thank you, you are now ready to begin helping out!
      </div>

      <div class="navigation">
        <a id="prevBtn" href="#" onclick="showStep('prev')" class="btn">Previous</a>
        <a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
        <a id="startContrib" href="../{{short_name}}/newtask" class="btn btn-primary"><i class="icon-thumbs-up"></i> Start helping out</a>
      </div>
    </div>
  </div>
{% endblock %}

{% block page_styles %}
  .navigation {
   margin-top: 10px;
  }
  .mapcontainer {
    position: relative;
  }
  .taskmanager {
    position: absolute;
  }
  #map {
    position: relative;
    width: 100%;
    height: 400px;
  }
  #maperrors {
    color: #ff0000;
    font-weight: bold;
  }
  #start {
    display: none;
  }
  .step {
    display: none;
  }
{% endblock %}

{% block page_libraries %}
  <script>
    var setMapTask = function (step) {
      setProgress({total: initializedSteps[step].tasks.length, done:initializedSteps[step].task});
      updateMap(initializedSteps[step].tasks[initializedSteps[step].task]);
      $("#mapcomment").html(initializedSteps[step].tasks[initializedSteps[step].task].comment || "");
      $("#maperrors").html("");
    };

    initializedSteps = {};
    function initializeStep(step) {
      if (initializedSteps[step] == undefined) {
        if ($("#" + step).hasClass("mapstep")) {
          initializedSteps[step] = {};
          initializedSteps[step].task = 0;
          initializedSteps[step].tasks = [
            {% block tasks %}
            {% endblock %}
          ];
          loadMap();
          setMapTask(step);
        } else {
          initializedSteps[step] = true;
        }
      }
    }

    function validateStep() {
      var answer = getAnswer();
      var errs = [];
      if ($("#" + step).hasClass("mapstep")) {
        var info = initializedSteps[step].tasks[initializedSteps[step].task];
        if (answer == undefined || answer.type == undefined) {
          errs.push("Please use one of the buttons at the bottom of the image to indicate the type of drill pad your see.");
        } else if (answer.type != info.answer) {
          errs.push("You selected " + answer.type + " while the correct answer was " + info.answer);
        }

        if (errs.length == 0 && initializedSteps[step].task < initializedSteps[step].tasks.length - 1) {
          initializedSteps[step].task++;
          setMapTask(step);
          return false;
        }
      }
      $("#maperrors").html(errs.join(""));
      return errs.length == 0;
    }

    var step = -1;
    function showStep(action) {
      var nrofsteps = $(".step").length;
      if (!validateStep()) return;

      $("#" + step).hide();

      if (action == 'next') {
        step = step + 1;
      }
      if (action == 'prev') {
        step = step - 1;
      }

      $("#prevBtn").toggle(step != 0);
      $("#nextBtn").toggle(step != nrofsteps - 1);
      $("#startContrib").toggle(step == nrofsteps - 1);
      $("#" + step).show();
      initializeStep(step);
    }


    $(document).ready(function () {
      showStep('next');
      $("#modal").modal('show');

      $(".step").each(function (idx, step) {
        $(step).attr("id", idx)
      });

      $($(".step")[0]).show();

      app.report_answer = function () {
        showStep('next');
      };
    });
  </script>
{% endblock %}
