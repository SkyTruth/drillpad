<div>
  <div id="0" class="step" style="display:none">
    <div class="row">
      <div class="span12">
        <h2>Pad shape outlining</h2>
        <p><strong>Hi!</strong> This is an application to help estimate the footprint of fracking operations for <a href="http://skytruth.org">SkyTruth</a>.</p>
        <p>The application is really simple. It loads a map with satelite imagery and asks you to draw an outline around any drill pad you see within a certain area.</p>
      </div>
    </div>
  </div>

  <div id="1" class="step" style="display:none">
    <div class="row">
      <div class="span12">
        <p>These are simple rectangular sites where the outline is pretty obvious. Draw a rectangle around the area, but don't include the access road.</p>
      </div>
    </div>

    <div class="row">
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/no+pad+visible/2010tioga_spudbuffer136.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/no+pad+visible/2010_X-079.2094_Y0041.5985.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/no+pad+visible/2010tioga_spudbuffer142.png" class="img-polaroid">
      </div>
    </div>
  </div>

  <div id="2" class="step" style="display:none">
    <div class="row">
      <div class="span12">
        <p>These are slightly overgrown sites. Be sure to include any part of the pad that has been overgrown, but again, don't include the access road.</p>
      </div>
    </div>

    <div class="row">
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/empty+well+pads/2010_X-076.9908_Y0041.9884.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/empty+well+pads/2010tioga_spudbuffer21.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/empty+well+pads/2010tioga_spudbuffer44.png" class="img-polaroid">
      </div>
    </div>
  </div>

  <div id="3" class="step" style="display:none">
    <div class="row">
      <div class="span12">
        <p>These sites are slightly more complex. As we're mainly interested in the environmental footprint of the drillpads, just outline the whole area as shown below.</p>
      </div>
    </div>

    <div class="row">
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/well+pads+w_equipment/2010tioga_spudbuffer11.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/well+pads+w_equipment/2010tioga_spudbuffer34.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/well+pads+w_equipment/2008_X-079.3670_Y0040.6300.png" class="img-polaroid">
      </div>
    </div>
  </div>

  <div id="4" class="step" style="display:none">
    <div class="row">
      <div class="span12">
        <p>These sites are mostly rectangular like the first ones we showed, but their outline is not as well defined, as some side sof the pad have grassy slopes down to the surrounding ground. Try to identify the outer edge of teh slopes as shown below.</p>
      </div>
    </div>

    <div class="row">
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/unknown/2008_X-079.6266_Y0040.7788.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/unknown/2008_X-079.5392_Y0040.8886.png" class="img-polaroid">
      </div>
      <div class="span4">
        <img src="https://s3.amazonaws.com/FrackFinder/Tadpole/well+pad+examples/unknown/2008_X-079.5970_Y0040.7876.png" class="img-polaroid">
      </div>
    </div>
  </div>

  <div id="5" class="step" style="display:none">
    <div class="row"><div class="span12"><h2>Test run</h2></div></div>
    <div class="skeleton">
        <div id="controls">
            <div class="row">
                <div class="span4 answer-buttons">
                    <h5><strong>Please mark the outline of the site in the imagery shown to the right</strong></h5>
                    <span id="maperrors"></span>
                    <div><button class="btn btn-success btn-answer" value="done"><i class="icon icon-white icon-play"></i> Done</button></div>
                    <div><button class="btn btn-danger btn-cancel"><i class="icon icon-white icon-undo"></i> Oups, scratch that</button></div>
                    <div><button class="btn btn-inverse btn-answer" value="skip"><i class="icon icon-white icon-forward"></i> Skip this pad</button></div>
                </div>
            </div>

            <div class="row">
                <div class="span4">
                    <!-- hr -->
                    <h4 id="progressmsg"><strong>Your Progress</strong></h4>
                    <span class="label label-warning">
                        <i class="icon icon-bullhorn"></i>
                            Tip
                    </span>
                    You can take a break whenever you want.  We'll be here when you get back.
                    <p>You are working on task: <span id="task-id" class="label">#</span></p>
                    <p>You have completed: <span id="done" class="label"></span> from a total of <span id="total" class="label"></span></p>
                    <div class="progress progress-striped">
                        <div id="progress" rel="tooltip" class="bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="span4">
                <h5><strong>We Value Your Feedback</strong></h5>               
                    <a href="http://frack.skytruth.org/frackfinder" target="_blank"><img src="https://s3.amazonaws.com/FrackFinder/skytruth_logo.png"></a>
                    <a href="https://www.facebook.com/groups/skytruthvolunteers/" target="_blank"><img src="http://cdn.crackberry.com/sites/crackberry.com/files/styles/large/public/topic_images/2013/facebook-logo-3.png" width="50" height="50"></a>
                    <div><a href="mailto:crowd@skytruth.org">crowd@skytruth.org</a></div>
                </div>
            </div>
        </div>
        <div id="mapcontainer"><div id="map"></div></div>
    </div>
  </div>

  <div id="6" class="step" style="display:none">
    <div class="row">
      <div class="span12">
        <h2>On your mark, get set, go!</h2>
        <p>Thank you, you are now ready to begin helping out!</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="span12">
      <br/>
      <a id="prevBtn" href="#" onclick="showStep('prev')" class="btn">Previous</a>
      <a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
      <a id="startContrib" href="../{{short_name}}/newtask" class="btn btn-primary" style="display:none"><i class="icon-thumbs-up"></i> Start helping out</a>
    </div>
  </div>
</div>

<style>
  @media (max-width: 979px) {
    .skeleton #controls,
    .skeleton #map {
      top: 50px !important;
    }
  }
  .navbar {
    z-index: 3;
    position: absolute;
  }
  .navbar-fixed-top, .navbar-fixed-bottom, .navbar-static-top {
    margin: 0;
  }
  body {
    padding: 0;
  }
  footer, html {
    background: white;
  }
  footer {
    display: none;
  }
  .alert-messages {
    position: absolute;
    z-index: 2;
    left: 80px;
    right: 80px;
    top: 140px;
  }
  .container {
    margin-top: 84px;
  }
  .navbar .container {
    margin-top: 0;
  }
  .container h1 {
    display: none;
  }
  .skeleton {
    display: table-row;
  }
  .skeleton #controls {
    display: table-cell;
    padding-right: 8pt;
  }
  .skeleton #mapcontainer {
    display: table-cell;
    width: 100%;
    height: 1px; // Hack to allow height: 100% on child element...
  }
  .skeleton #mapcontainer #map {
    height: 100%;
    width: 100%;
  }
  #maperrors {
    color: #ff0000;
    font-weight: bold;
  }
  #start {
    display: none;
  }
</style>


<script src="http://openlayers.org/dev/OpenLayers.js"></script>
<script src="http://maps.google.com/maps/api/js?v=3&amp;sensor=false"></script>

<script>
  {% include "cricketfrog/maphandler.js" %}


  OpenLayers.Geometry.Polygon.prototype.contains = function(geometry) {
      var i, len;
      if (geometry.CLASS_NAME == "OpenLayers.Geometry.Point") {
          return this.containsPoint(geometry);
      } else if (geometry.CLASS_NAME == "OpenLayers.Geometry.Polygon") {
          // A polygon is contained if its outer contour is contained,
          // and none of it covers any holes in this geometry
          var outercontour = geometry.components[0];
          for (i=0, len=outercontour.components.length; i<len; ++i) {
              if (!this.containsPoint(outercontour.components[i])) return false;
          }
          // Check that any holes in this polygon does not cover geometry
          for (i=1, len=this.components.length; i<len; ++i) {
              if (this.components[i].intersects(geometry)) return false;
          }
          return true;
      } else {
          // Any other shape is contained if all of its components are
          for (i=0, len=this.components.length; i<len; ++i) {
              if (!this.contains(this.components[i])) return false
          }
          return true;
      }
  };


  var setMapTask = function (step) {
    setProgress({total: initializedSteps[step].tasks.length, done:initializedSteps[step].task});
    updateMap(initializedSteps[step].tasks[initializedSteps[step].task]);
  };

  initializedSteps = {};
  function initializeStep(step) {
    if (initializedSteps[step] == undefined) {
      if (step == 5) {
        initializedSteps[step] = {};
        initializedSteps[step].task = 0;
        initializedSteps[step].tasks = [
          {
            "url": "http://ewn4.skytruth.org/test/Tioga/2010_X-076.9588_Y0041.6822.png",
            "bbox": "-8567215.4491574950516224,5113293.3045046702027321,-8566815.0137488394975662,5113693.7399133248254657",
            "outer": {"type":"Polygon","coordinates":[[[-8567107.1947528,5113362.1460667],[-8566874.3006823,5113392.0042808],[-8566844.4424681,5113630.8699942],[-8567156.1622241,5113596.2344657],[-8567107.1947528,5113362.1460667]]]},
            "inner": {"type":"Polygon","coordinates":[[[-8567064.7960887,5113454.1093663],[-8566968.0554748,5113467.2469805],[-8566976.4157748,5113543.6840088],[-8567075.5450458,5113531.7407231],[-8567064.7960887,5113454.1093663]]]},
            "width": 299, "height": 299,
            "guuid":"foobar"
          },
          {
            "url": "http://ewn4.skytruth.org/test/Tioga/2010_X-076.9588_Y0041.6822.png",
            "bbox": "-8567215.4491574950516224,5113293.3045046702027321,-8566815.0137488394975662,5113693.7399133248254657",
            "outer": {"type":"Polygon","coordinates":[[[-8567107.1947528,5113362.1460667],[-8566874.3006823,5113392.0042808],[-8566844.4424681,5113630.8699942],[-8567156.1622241,5113596.2344657],[-8567107.1947528,5113362.1460667]]]},
            "inner": {"type":"Polygon","coordinates":[[[-8567064.7960887,5113454.1093663],[-8566968.0554748,5113467.2469805],[-8566976.4157748,5113543.6840088],[-8567075.5450458,5113531.7407231],[-8567064.7960887,5113454.1093663]]]},
            "width": 299, "height": 299,
            "guuid":"foobar"
          }
        ];

console.log(initializedSteps[step]);

        loadMap();
        setMapTask(step);
        $('.btn-cancel').click(clearData);
        $('.btn-answer').click(function () { showStep('next'); });

      } else {
        initializedSteps[step] = true;
      }
    }
  }

  function validateStep() {
    var errs = [];
    if (step == 5) {
      var geojson = new OpenLayers.Format.GeoJSON();
      var info = map.getLayer('drillpads').taskinfo;
      var data = getTaskData();
      var shape = geojson.read(data.shape, "Geometry");
      var inner = geojson.read(info.inner, "Geometry");
      var outer = geojson.read(info.outer, "Geometry");

      if (outer.contains(shape)) {
        if (!shape.contains(inner)) {
          errs.push("<div>Your shape is too small</div>")
        }
      } else {
        if (!shape.contains(inner)) {
          errs.push("<div>Your shape is not in the right location</div>")
        } else {
          errs.push("<div>Your shape is too big</div>")
        }
      }

      if (errs.length == 0 && initializedSteps[step].task < initializedSteps[step].tasks.length - 1) {
        initializedSteps[step].task++;
        setMapTask(step);
        return false;
      }

    }
    $("#maperrors").html(errs.join(""));
    return errs.length == 0;
  }


  var step = -1;
  function showStep(action) {
    if (!validateStep()) return;

    $("#" + step).hide();

    if (action == 'next') {
      step = step + 1;
    }
    if (action == 'prev') {
      step = step - 1;
    }

    $("#prevBtn").toggle(step != 0);
    $("#nextBtn").toggle(step != 6);
    $("#startContrib").toggle(step == 6);
    $("#" + step).show();
    initializeStep(step);
  }

  $(document).ready(function () {
    showStep('next');
    $("#modal").modal('show');
  });
</script>
